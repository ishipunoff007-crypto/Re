<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Панель управления — Автосервис на Панина</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container admin-panel">
    <h1>Панель управления</h1>

    <div class="toggle-container">
      <span class="toggle-label">Статус записи:</span>
      <label class="toggle-switch">
        <input type="checkbox" id="bookingToggle">
        <span class="slider"></span>
      </label>
      <span id="bookingStatusText"></span>
    </div>

    <button class="btn-primary" id="refreshBtn">Обновить список записей</button>

    <h2>Последние записи клиентов</h2>
    <div class="bookings-table-container">
      <table class="bookings-table">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Время</th>
            <th>Имя</th>
            <th>Телефон</th>
            <th>Услуга</th>
            <th>Модель</th>
            <th>Комментарий</th>
            <th>Статус</th>
          </tr>
        </thead>
        <tbody id="bookingsTableBody">
          <tr><td colspan="8">Загрузка...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzc5RyRZefzGEWq_GCg2QM6Bh0uZYvsisptM2hEtQnrKpvn3GFdgbSiN4vXLlzRQaXC/exec"; // вставь тот же URL, что и в script.js

    document.addEventListener("DOMContentLoaded", async () => {
      await loadBookingStatus();
      await loadRecentBookings();

      document.getElementById("bookingToggle").addEventListener("change", toggleBooking);
      document.getElementById("refreshBtn").addEventListener("click", loadRecentBookings);
    });

    // === Получение текущего статуса ===
    async function loadBookingStatus() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getBookingStatus`);
        const data = await response.json();

        const toggle = document.getElementById("bookingToggle");
        const statusText = document.getElementById("bookingStatusText");

        toggle.checked = data.isActive;
        statusText.textContent = data.isActive ? "Активна" : "Приостановлена";
        statusText.style.color = data.isActive ? "green" : "red";
      } catch (err) {
        console.error("Ошибка загрузки статуса:", err);
      }
    }

    // === Переключение статуса ===
    async function toggleBooking(e) {
      const newStatus = e.target.checked;
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "toggleBooking",
            status: newStatus
          })
        });

        const data = await response.json();
        alert(data.message || "Статус обновлён!");
        await loadBookingStatus();

      } catch (err) {
        console.error("Ошибка изменения статуса:", err);
        alert("Не удалось изменить статус записи.");
        e.target.checked = !newStatus; // вернуть в прежнее положение
      }
    }

    // === Получение последних записей ===
    async function loadRecentBookings() {
      const tbody = document.getElementById("bookingsTableBody");
      tbody.innerHTML = "<tr><td colspan='8'>Загрузка...</td></tr>";

      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getRecentBookings`);
        const data = await response.json();

        if (!data.bookings || data.bookings.length === 0) {
          tbody.innerHTML = "<tr><td colspan='8'>Записей пока нет</td></tr>";
          return;
        }

        tbody.innerHTML = "";
        data.bookings.forEach(b => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${b.date || "-"}</td>
            <td>${b.time || "-"}</td>
            <td>${b.name || "-"}</td>
            <td>${b.phone || "-"}</td>
            <td>${b.service || "-"}</td>
            <td>${b.carModel || "-"}</td>
            <td>${b.comments || ""}</td>
            <td>${b.status || "-"}</td>
          `;
          tbody.appendChild(row);
        });

      } catch (err) {
        console.error("Ошибка загрузки записей:", err);
        tbody.innerHTML = "<tr><td colspan='8'>Ошибка загрузки данных</td></tr>";
      }
    }
  </script>
</body>
</html>
